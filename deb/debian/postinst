#!/bin/bash

# post-upgrade only
if [ "$1" = "configure" ] && [ $2 ]; then
  echo "Running post-upgrade steps..."

  # stop homebridge.service if it is running
  if systemctl is-active --quiet homebridge.service; then
    echo "Stopping Homebridge service..."
    systemctl stop homebridge.service 2> /dev/null
  fi

  # merge old package.json with new one:
  if [ -f /tmp/homebridge-tmp/package.json ] && [ -f /var/lib/homebridge/package.json ]; then
    echo "Merging package.json file..."

    # enter homebridge env
    . "/usr/lib/homebridge/source.sh"

    # merge the new package.json into the old one, and save
    PACKAGE_JSON=$(jq -M -s '.[0] * .[1]' /tmp/homebridge-tmp/package.json /var/lib/homebridge/package.json) > /var/lib/homebridge/package.json
    if [ "$?" = "0" ]; then
      echo $PACKAGE_JSON | jq '.' > /var/lib/homebridge/package.json
    fi

    # Re-install user plugins
    echo "Re-installing user plugins, this may take a few minutes, please wait..."
    pnpm -C /var/lib/homebridge install

    # remove tmp package.json
    rm -rf /tmp/homebridge-tmp/package.json
  fi
fi

# post-install and post-upgrade
if [ "$1" = "configure" ]; then
  echo "Running post-install steps..."

  # create user
  adduser --system homebridge 2> /dev/null

  # copy .bashrc to service user home
  cp /usr/lib/homebridge/bashrc /home/homebridge/.bashrc

  # fix permissions
  chown -R homebridge: /var/lib/homebridge /usr/lib/homebridge /home/homebridge/.bashrc

  # clear any masks on the homebridge service
  systemctl unmask homebridge.service 2> /dev/null

  # reload systemctl
  systemctl daemon-reload

  # enable systemctl service
  systemctl enable homebridge.service

  # start / restart homebridge
  echo "Starting Homebridge service...."
  systemctl restart homebridge.service

  # create symlink to hb-shell
  ln -fs /usr/lib/homebridge/hb-shell /usr/bin/hb-shell

  # add user to default groups if running on raspbian
  . /etc/os-release
  if [ "$ID" = "raspbian" ]; then
    for groupName in udio bluetooth dialout gpio video input i2c spi audio render; do
      usermod -a -G $groupName homebridge 2> /dev/null
    done
  fi
fi

exit 0